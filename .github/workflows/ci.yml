name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  lint-python:
    name: Python Linting & Code Quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt

      - name: Run black formatter check
        run: |
          black --check --diff build_configs/

      - name: Run isort import check
        run: |
          isort --check-only --diff build_configs/

      - name: Run flake8 linter
        run: |
          flake8 build_configs/ --max-line-length=100 --extend-ignore=E203,W503
        continue-on-error: true

      - name: Run mypy type checker
        run: |
          mypy build_configs/ --ignore-missing-imports
        continue-on-error: true

  security-scan:
    name: Security & Dependency Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run pip-audit for vulnerability scanning
        run: |
          pip-audit --requirement requirements.txt --format json --output pip-audit-report.json || true
          pip-audit --requirement requirements.txt || true

      - name: Upload pip-audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pip-audit-report
          path: pip-audit-report.json
          retention-days: 30

      - name: Check for security issues with bandit
        run: |
          pip install bandit
          bandit -r build_configs/ -f json -o bandit-report.json || true
          bandit -r build_configs/ || true
        continue-on-error: true

      - name: Upload bandit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-report
          path: bandit-report.json
          retention-days: 30

  validate-requirements:
    name: Validate Requirements
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Validate requirements.txt
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt --dry-run 2>&1 | tee install-check.log || pip install -r requirements.txt

      - name: Verify all packages installed correctly
        run: |
          pip check

      - name: Generate dependency tree
        run: |
          pip install pipdeptree
          pipdeptree > dependency-tree.txt
          cat dependency-tree.txt

      - name: Upload dependency tree
        uses: actions/upload-artifact@v4
        with:
          name: dependency-tree-py${{ matrix.python-version }}
          path: dependency-tree.txt
          retention-days: 30

  validate-structure:
    name: Validate Project Structure
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required files
        run: |
          echo "Checking required files..."
          test -f requirements.txt && echo "✓ requirements.txt exists" || (echo "✗ requirements.txt missing" && exit 1)
          test -f requirements-dev.txt && echo "✓ requirements-dev.txt exists" || (echo "✗ requirements-dev.txt missing" && exit 1)
          test -f README.md && echo "✓ README.md exists" || (echo "✗ README.md missing" && exit 1)
          test -f startup.sh && echo "✓ startup.sh exists" || (echo "✗ startup.sh missing" && exit 1)
          test -d applications_user && echo "✓ applications_user directory exists" || (echo "✗ applications_user missing" && exit 1)
          test -d build_configs && echo "✓ build_configs directory exists" || (echo "✗ build_configs missing" && exit 1)
          test -f .gitignore && echo "✓ .gitignore exists" || (echo "✗ .gitignore missing" && exit 1)

      - name: Validate startup.sh is executable
        run: |
          if [ -f startup.sh ]; then
            if [ -x startup.sh ]; then
              echo "✓ startup.sh is executable"
            else
              echo "⚠ startup.sh exists but is not executable"
              exit 1
            fi
          fi

      - name: Check for common issues
        run: |
          echo "Checking for common issues..."
          
          # Check for TODO/FIXME comments
          echo "Scanning for TODO/FIXME markers..."
          grep -r "TODO\|FIXME" --include="*.py" --include="*.sh" . || echo "✓ No TODO/FIXME found"
          
          # Check Python files syntax
          echo "Validating Python syntax..."
          find . -name "*.py" -type f -exec python3 -m py_compile {} \; && echo "✓ All Python files have valid syntax"
          
          # Check shell scripts syntax
          echo "Validating shell scripts..."
          find . -name "*.sh" -type f -exec bash -n {} \; && echo "✓ All shell scripts have valid syntax"

  generate-docs:
    name: Generate Documentation
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install sphinx sphinx-rtd-theme myst-parser

      - name: Generate workflow documentation
        run: |
          cat > WORKFLOW_REVIEW.md << 'EOF'
          # Workflow Review Log
          
          ## CI/CD Pipeline Overview
          
          ### Jobs
          
          1. **Python Linting & Code Quality**
             - Matrix testing across Python 3.11 and 3.12
             - Black formatter verification
             - isort import sorting check
             - flake8 linting (with reasonable ignores)
             - mypy type checking
          
          2. **Security & Dependency Scanning**
             - pip-audit for known vulnerabilities
             - bandit for security issues in code
             - Automated reports uploaded as artifacts
          
          3. **Validate Requirements**
             - Tests installation on multiple Python versions
             - Verifies package compatibility with `pip check`
             - Generates dependency tree for review
          
          4. **Validate Project Structure**
             - Checks for required files and directories
             - Validates executable permissions
             - Syntax checking for Python and shell scripts
             - Scans for TODO/FIXME markers
          
          5. **Generate Documentation**
             - Creates workflow documentation
             - Prepares for Sphinx documentation generation
          
          ## Dependencies
          
          ### Core Build Dependencies
          - scons: Build system for FBT
          - protobuf: Communication protocol
          - Pillow: Image processing
          - pyserial: USB communication
          - heatshrink2: Compression
          - ansicolors: Terminal colors
          
          ### Code Quality Tools
          - black: Code formatting
          - isort: Import sorting
          - flake8: Linting
          - mypy: Type checking
          
          ### Security Tools
          - pip-audit: Vulnerability scanning
          - safety: Security checking
          - bandit: Security linting
          
          ### Development Tools
          - pre-commit: Git hooks
          - pytest: Testing framework
          - pytest-cov: Coverage reporting
          
          ## Optimization Summary
          
          ### Improvements Made
          1. ✅ Pinned all dependency versions for reproducibility
          2. ✅ Added Python version matrix (3.11, 3.12)
          3. ✅ Upgraded GitHub Actions to v4/v5
          4. ✅ Added comprehensive security scanning
          5. ✅ Added dependency tree generation
          6. ✅ Improved caching with setup-python cache
          7. ✅ Added additional linting tools (flake8, mypy)
          8. ✅ Created requirements-dev.txt for development
          9. ✅ Enhanced structure validation
          10. ✅ Added artifact uploads for reports
          
          ### Best Practices
          - Use pinned versions in production
          - Regular security scans
          - Multi-version Python testing
          - Comprehensive linting
          - Automated documentation generation
          
          ## Next Steps
          
          1. Review and merge this PR
          2. Set up pre-commit hooks locally
          3. Consider adding unit tests
          4. Review security scan results regularly
          5. Update dependencies periodically
          
          EOF
          cat WORKFLOW_REVIEW.md

      - name: Upload workflow documentation
        uses: actions/upload-artifact@v4
        with:
          name: workflow-documentation
          path: WORKFLOW_REVIEW.md
          retention-days: 90
